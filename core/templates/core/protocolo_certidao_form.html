{% extends 'core/base.html' %}
{% load format_utils %}

{% block title %}{{ title }} - Sistema de Protocolos{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
        <div>
            <h1 class="mb-2">
                <i class="bi bi-file-earmark-text me-2"></i>
                {% if is_edit %}Certidão #{{ protocolo.numero_protocolo }}{% else %}Nova Certidão{% endif %}
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'protocolo_list_em_andamento' %}">Protocolos</a></li>
                    <li class="breadcrumb-item active">
                        {% if is_edit %}Editar Certidão{% else %}Nova Certidão{% endif %}
                    </li>
                </ol>
            </nav>
        </div>

        {% if is_edit and protocolo %}
        <span class="badge bg-primary px-3 py-2 fs-6">
            {{ protocolo.get_status_display }}
        </span>
        {% endif %}
    </div>

    {% if is_edit and protocolo %}
    <!-- Info Cards Row -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card border-0 bg-primary-subtle">
                <div class="card-body py-2">
                    <div class="small text-muted">Protocolo</div>
                    <div class="fw-bold text-primary fs-5">#{{ protocolo.numero_protocolo }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info-subtle">
                <div class="card-body py-2">
                    <div class="small text-muted">Tipo de Ato</div>
                    <div class="fw-bold text-info">{{ protocolo.tipo_ato.nome }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-secondary-subtle">
                <div class="card-body py-2">
                    <div class="small text-muted">Criado em</div>
                    <div class="fw-bold text-secondary">{{ protocolo.data_criacao|date:"d/m/Y H:i" }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success-subtle">
                <div class="card-body py-2">
                    <div class="small text-muted">Criado por</div>
                    <div class="fw-bold text-success">
                        {{ protocolo.criado_por.get_full_name|default:protocolo.criado_por.username }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<form method="post" id="formProtocolo" novalidate>
    {% csrf_token %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>Sucesso!</strong> Protocolo atualizado.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ form.non_field_errors|join:', ' }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Tab Card -->
    <div class="card">
        <div class="card-header p-0 bg-transparent border-bottom">
            <ul class="nav nav-tabs card-header-tabs mb-0" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="visao-geral-tab" data-bs-toggle="tab"
                            data-bs-target="#visao-geral-pane" type="button" role="tab">
                        <i class="bi bi-eye me-1"></i>Visão Geral
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comentarios-tab" data-bs-toggle="tab"
                            data-bs-target="#comentarios-pane" type="button" role="tab">
                        <i class="bi bi-chat-left-text me-1"></i>Comentários
                        {% if comentarios %}
                        <span class="badge bg-primary-subtle text-primary ms-1">{{ comentarios|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tarefas-tab" data-bs-toggle="tab"
                            data-bs-target="#tarefas-pane" type="button" role="tab">
                        <i class="bi bi-list-check me-1"></i>Tarefas
                    </button>
                </li>
                <!-- Hidden para Certidões -->
                <li class="nav-item" role="presentation" style="display: none;">
                    <button class="nav-link" id="escritura-tab" disabled>
                        <i class="bi bi-pencil-square me-1"></i>Controle da Escritura
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="conclusao-tab" data-bs-toggle="tooltip"
                            title="Disponível ao finalizar protocolo" disabled>
                        <i class="bi bi-check-circle me-1"></i>Conclusão
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="protocoloTabContent">

                <!-- ========== TAB 1: VISÃO GERAL ========== -->
                <div class="tab-pane fade show active" id="visao-geral-pane" role="tabpanel">

                    <!-- Card 1.1: Dados do Pedido -->
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-light">
                            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Dados do Pedido</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    {{ form.responsavel.label_tag }}
                                    {{ form.responsavel }}
                                    {% if form.responsavel.errors %}
                                        <div class="invalid-feedback d-block">{{ form.responsavel.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    {{ form.data_agendamento.label_tag }}
                                    {{ form.data_agendamento }}
                                    {% if form.data_agendamento.errors %}
                                        <div class="invalid-feedback d-block">{{ form.data_agendamento.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    {{ form.horario_agendamento.label_tag }}
                                    {{ form.horario_agendamento }}
                                    {% if form.horario_agendamento.errors %}
                                        <div class="invalid-feedback d-block">{{ form.horario_agendamento.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    {{ form.deposito_previo.label_tag }}
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        {{ form.deposito_previo }}
                                    </div>
                                    {% if form.deposito_previo.errors %}
                                        <div class="invalid-feedback d-block">{{ form.deposito_previo.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 1.2: Solicitantes (READ ONLY) -->
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-light">
                            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Solicitantes (Clientes)</h5>
                        </div>
                        <div class="card-body">
                            {% if protocolo.clientes.exists %}
                                {% for cliente in protocolo.clientes.all %}
                                <div class="card border mb-3">
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <div class="small text-muted mb-1">
                                                    {% if cliente.cpf %}CPF{% else %}CNPJ{% endif %}
                                                </div>
                                                <div class="fw-medium">
                                                    {% if cliente.cpf %}
                                                        {{ cliente.cpf|format_cpf }}
                                                    {% else %}
                                                        {{ cliente.cnpj|format_cnpj }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="small text-muted mb-1">Nome</div>
                                                <div class="fw-medium">{{ cliente.nome }}</div>
                                            </div>
                                            {% if cliente.telefone %}
                                            <div class="col-md-4">
                                                <div class="small text-muted mb-1">
                                                    <i class="bi bi-telephone"></i> Telefone
                                                </div>
                                                <div>{{ cliente.telefone|format_telefone }}</div>
                                            </div>
                                            {% endif %}
                                            {% if cliente.email %}
                                            <div class="col-md-8">
                                                <div class="small text-muted mb-1">
                                                    <i class="bi bi-envelope"></i> E-mail
                                                </div>
                                                <div>{{ cliente.email }}</div>
                                            </div>
                                            {% endif %}
                                            {% if cliente.endereco %}
                                            <div class="col-12">
                                                <div class="small text-muted mb-1">
                                                    <i class="bi bi-geo-alt"></i> Endereço
                                                </div>
                                                <div>{{ cliente.endereco }}</div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle me-1"></i>Nenhum solicitante cadastrado.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Card 1.3: Advogados (READ ONLY) -->
                    {% if protocolo.advogados.exists %}
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-light">
                            <h5 class="mb-0"><i class="bi bi-briefcase me-2"></i>Advogados</h5>
                        </div>
                        <div class="card-body">
                            {% for advogado in protocolo.advogados.all %}
                            <div class="card border mb-3">
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="small text-muted mb-1">CPF</div>
                                            <div class="fw-medium">{{ advogado.cpf|format_cpf }}</div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="small text-muted mb-1">Nome</div>
                                            <div class="fw-medium">{{ advogado.nome }}</div>
                                        </div>
                                        {% if advogado.telefone %}
                                        <div class="col-md-4">
                                            <div class="small text-muted mb-1">
                                                <i class="bi bi-telephone"></i> Telefone
                                            </div>
                                            <div>{{ advogado.telefone|format_telefone }}</div>
                                        </div>
                                        {% endif %}
                                        {% if advogado.email %}
                                        <div class="col-md-8">
                                            <div class="small text-muted mb-1">
                                                <i class="bi bi-envelope"></i> E-mail
                                            </div>
                                            <div>{{ advogado.email }}</div>
                                        </div>
                                        {% endif %}
                                        {% if advogado.endereco %}
                                        <div class="col-12">
                                            <div class="small text-muted mb-1">
                                                <i class="bi bi-geo-alt"></i> Endereço
                                            </div>
                                            <div>{{ advogado.endereco }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Card 1.4: Documentos (READ ONLY) -->
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-light">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Documentos Solicitados</h5>
                        </div>
                        <div class="card-body">
                            {% if protocolo.lista_documentos %}
                                <ul class="list-unstyled mb-0">
                                    {% for doc in protocolo.lista_documentos %}
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>{{ doc }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle me-1"></i>Nenhum documento especificado.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Card 1.5: Observações -->
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-light">
                            <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Observações</h5>
                        </div>
                        <div class="card-body">
                            {{ form.observacoes.label_tag }}
                            {{ form.observacoes }}
                            {% if form.observacoes.errors %}
                                <div class="invalid-feedback d-block">{{ form.observacoes.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                Utilize este campo para anotações gerais sobre o protocolo.
                            </div>
                        </div>
                    </div>

                </div>

                <!-- ========== TAB 2: COMENTÁRIOS ========== -->
                <div class="tab-pane fade" id="comentarios-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <h5 class="mb-4">
                                <i class="bi bi-chat-left-text me-2"></i>Comentários Internos
                            </h5>

                            <!-- Lista de Comentários Existentes -->
                            {% if comentarios %}
                                {% for comentario in comentarios %}
                                <div class="card mb-3 border-start border-primary border-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong class="text-primary">
                                                    {{ comentario.usuario.get_full_name|default:comentario.usuario.username }}
                                                </strong>
                                                <span class="badge bg-secondary-subtle text-secondary ms-2">
                                                    {{ comentario.usuario.get_role_display }}
                                                </span>
                                            </div>
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>
                                                {{ comentario.data_criacao|date:"d/m/Y H:i" }}
                                            </small>
                                        </div>
                                        <p class="mb-0">{{ comentario.texto|linebreaks }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Nenhum comentário registrado ainda.
                                </div>
                            {% endif %}

                            <!-- Placeholder: Adicionar Comentário -->
                            <div class="card bg-light border-0 mt-4">
                                <div class="card-body">
                                    <h6 class="mb-3">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar Comentário
                                    </h6>
                                    <textarea class="form-control mb-3" rows="3"
                                              placeholder="Digite seu comentário..." disabled></textarea>
                                    <button type="button" class="btn btn-primary" disabled>
                                        <i class="bi bi-send me-1"></i>Adicionar Comentário
                                    </button>
                                    <div class="form-text mt-2">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Funcionalidade em desenvolvimento
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 3: TAREFAS ========== -->
                <div class="tab-pane fade" id="tarefas-pane" role="tabpanel">
                    <div class="text-center py-5">
                        <i class="bi bi-list-check text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-muted">Em breve: Gestão de Tarefas</h4>
                        <p class="text-muted">
                            Esta funcionalidade permitirá criar e acompanhar tarefas relacionadas ao protocolo.
                        </p>
                    </div>
                </div>

                <!-- ========== TAB 4: CONTROLE DA ESCRITURA (HIDDEN) ========== -->
                <div class="tab-pane fade" id="escritura-pane" role="tabpanel" style="display: none;">
                    <!-- Tab exclusiva para Atos Notariais - hidden para Certidões -->
                </div>

                <!-- ========== TAB 5: CONCLUSÃO ========== -->
                <div class="tab-pane fade" id="conclusao-pane" role="tabpanel">
                    <div class="text-center py-5">
                        <i class="bi bi-check-circle text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-muted">Conclusão do Protocolo</h4>
                        <p class="text-muted">
                            Esta aba será habilitada quando o protocolo estiver pronto para conclusão.
                        </p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Action Footer -->
        <div class="card-footer bg-transparent border-top mt-0">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <!-- Botões à Esquerda -->
                <div class="d-flex gap-2">
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i>Imprimir Protocolo
                    </button>
                </div>

                <!-- Botões à Direita -->
                <div class="d-flex gap-2">
                    <!-- Oculto para Certidões -->
                    <button type="button" class="btn btn-warning" style="display: none;" disabled>
                        <i class="bi bi-pencil-square me-1"></i>Declarar Ato Escriturado
                    </button>

                    <!-- Botão de Salvar - Visível apenas se user_can_edit -->
                    {% if user_can_edit %}
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg me-1"></i>Salvar Alterações
                    </button>
                    {% endif %}

                    <!-- Botão Concluir - Placeholder para implementação futura -->
                    <button type="button" class="btn btn-success" disabled
                            data-bs-toggle="tooltip"
                            title="Funcionalidade em desenvolvimento">
                        <i class="bi bi-check-circle me-1"></i>Concluir Certidão
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips Bootstrap
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(el => new bootstrap.Tooltip(el));

    // Persistência de aba ativa (sessionStorage)
    const activeTab = sessionStorage.getItem('activeProtocolTab');
    if (activeTab) {
        const tab = document.querySelector(`button[data-bs-target="${activeTab}"]`);
        if (tab && !tab.disabled) {
            new bootstrap.Tab(tab).show();
        }
    }

    // Salvar aba ativa ao trocar
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', e => {
            sessionStorage.setItem('activeProtocolTab', e.target.getAttribute('data-bs-target'));
        });
    });
});
</script>
{% endblock %}
