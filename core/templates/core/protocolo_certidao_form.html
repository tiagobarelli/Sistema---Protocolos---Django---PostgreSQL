{% extends 'core/base.html' %}
{% load format_utils %}

{% block title %}{{ title }} - Sistema de Protocolos{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1><i class="bi bi-file-earmark-text me-2"></i>{{ title }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Início</a></li>
                <li class="breadcrumb-item active">Protocolo de Certidão</li>
            </ol>
        </nav>
    </div>
    {% if is_edit and protocolo %}
    <span class="badge bg-primary-subtle text-primary px-3 py-2 fs-6">
        <i class="bi bi-hash me-1"></i>{{ protocolo.numero_protocolo }}
    </span>
    {% endif %}
</div>

<form method="post" id="formProtocolo" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ form.non_field_errors|join:', ' }}
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- Coluna Principal -->
        <div class="col-12 col-xl-8">
            
            <!-- Card: Dados do Pedido -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h5 class="mb-0"><i class="bi bi-clipboard me-2"></i>Dados do Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-medium" for="id_tipo_ato">
                                Tipo de Certidão <span class="text-danger">*</span>
                            </label>
                            {{ form.tipo_ato }}
                            {% if form.tipo_ato.errors %}
                            <div class="invalid-feedback d-block">{{ form.tipo_ato.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium" for="id_data_agendamento">
                                Data de Entrega
                            </label>
                            {{ form.data_agendamento }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium" for="id_horario_agendamento">
                                Horário
                            </label>
                            {{ form.horario_agendamento }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Solicitantes (Clientes) -->
            <div class="card mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Solicitantes</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarPessoa('cliente')">
                        <i class="bi bi-plus-lg me-1"></i>Adicionar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="tabelaClientes">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 200px;">CPF/CNPJ</th>
                                    <th>Nome</th>
                                    <th style="width: 60px;" class="text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="listaClientes">
                                <!-- Linhas serão adicionadas via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-light border-top text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Digite o CPF/CNPJ e pressione Tab. Se o cliente existir, o nome será preenchido automaticamente.
                    </div>
                </div>
            </div>

            <!-- Card: Advogados (Toggle) -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-briefcase me-2"></i>Advogados</h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" role="switch" 
                                   id="toggle_advogados" name="tem_advogado"
                                   {% if has_advogados %}checked{% endif %}>
                            <label class="form-check-label" for="toggle_advogados">Possui advogado?</label>
                        </div>
                    </div>
                </div>
                <div id="advogados_container" style="{% if not has_advogados %}display: none;{% endif %}">
                    <div class="card-body p-0">
                        <div class="d-flex justify-content-end p-2 bg-light border-bottom">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarPessoa('advogado')">
                                <i class="bi bi-plus-lg me-1"></i>Adicionar Advogado
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tabelaAdvogados">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 200px;">CPF</th>
                                        <th>Nome do Advogado</th>
                                        <th style="width: 60px;" class="text-center">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="listaAdvogados">
                                    <!-- Linhas serão adicionadas via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-3 bg-light border-top text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            Advogados devem ser cadastrados com CPF (pessoa física).
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Lista de Documentos -->
            <div class="card mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-check me-2"></i>Documentos Solicitados</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarDocumento()">
                        <i class="bi bi-plus-lg me-1"></i>Adicionar
                    </button>
                </div>
                <div class="card-body" id="listaDocumentos">
                    <!-- Itens serão adicionados via JS -->
                </div>
                <div class="card-footer bg-light text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Liste os documentos que o cliente precisa apresentar ou que serão emitidos.
                </div>
            </div>

            <!-- Card: Observações -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>Observações</h5>
                </div>
                <div class="card-body">
                    {{ form.observacoes }}
                </div>
            </div>
        </div>

        <!-- Coluna Lateral -->
        <div class="col-12 col-xl-4">
            <!-- Card: Financeiro -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Financeiro</h5>
                </div>
                <div class="card-body">
                    <label class="form-label fw-medium" for="id_deposito_previo">
                        Depósito Prévio (R$) <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        {{ form.deposito_previo }}
                    </div>
                    {% if form.deposito_previo.errors %}
                    <div class="invalid-feedback d-block">{{ form.deposito_previo.errors|join:', ' }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Card: Resumo/Ajuda -->
            <div class="card bg-light border-0">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-lightbulb me-1"></i>Dicas</h6>
                    <hr>
                    <ul class="small text-muted mb-0 ps-3">
                        <li class="mb-2">Adicione ao menos um <strong>solicitante</strong>.</li>
                        <li class="mb-2">Se o cliente não existir, ele será <strong>cadastrado automaticamente</strong> ao salvar.</li>
                        <li class="mb-2">Advogados usam a mesma base de clientes.</li>
                        <li>Documentos são opcionais, mas ajudam no controle.</li>
                    </ul>
                </div>
            </div>

            {% if is_edit and protocolo %}
            <div class="card border-0 bg-info-subtle mt-3">
                <div class="card-body">
                    <h6 class="text-info"><i class="bi bi-info-circle me-1"></i>Informações</h6>
                    <hr class="border-info">
                    <ul class="list-unstyled small mb-0">
                        <li><strong>Criado por:</strong> {{ protocolo.criado_por.get_full_name|default:protocolo.criado_por.username }}</li>
                        <li><strong>Data:</strong> {{ protocolo.data_criacao|date:"d/m/Y H:i" }}</li>
                        <li><strong>Status:</strong> {{ protocolo.get_status_display }}</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="d-flex justify-content-end gap-2 mt-4 mb-5">
        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-lg me-1"></i>Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-lg me-1"></i>{{ button_text }}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
    .pessoa-row input:read-only {
        background-color: #e9ecef;
    }
    
    .documento-item {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .documento-item input {
        flex: 1;
    }
    
    #listaDocumentos:empty::after {
        content: 'Nenhum documento adicionado. Clique em "Adicionar" para incluir.';
        display: block;
        text-align: center;
        color: #6c757d;
        padding: 2rem;
    }
    
    #listaClientes:empty::after,
    #listaAdvogados:empty::after {
        content: 'Nenhum registro. Clique em "Adicionar" para incluir.';
        display: block;
        text-align: center;
        color: #6c757d;
        padding: 2rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ========== MÁSCARAS ==========
    
    function maskCPF(value) {
        let v = value.replace(/\D/g, '').substring(0, 11);
        if (v.length > 9) {
            v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        } else if (v.length > 6) {
            v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
        } else if (v.length > 3) {
            v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
        }
        return v;
    }
    
    function maskCNPJ(value) {
        let v = value.replace(/\D/g, '').substring(0, 14);
        if (v.length > 12) {
            v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{1,2})/, '$1.$2.$3/$4-$5');
        } else if (v.length > 8) {
            v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{1,4})/, '$1.$2.$3/$4');
        } else if (v.length > 5) {
            v = v.replace(/(\d{2})(\d{3})(\d{1,3})/, '$1.$2.$3');
        } else if (v.length > 2) {
            v = v.replace(/(\d{2})(\d{1,3})/, '$1.$2');
        }
        return v;
    }
    
    function maskDocumento(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length <= 11) {
            return maskCPF(value);
        } else {
            return maskCNPJ(value);
        }
    }
    
    // ========== TOGGLE ADVOGADOS ==========
    
    const toggleAdvogados = document.getElementById('toggle_advogados');
    const advogadosContainer = document.getElementById('advogados_container');
    
    toggleAdvogados.addEventListener('change', function() {
        if (this.checked) {
            advogadosContainer.style.display = 'block';
        } else {
            advogadosContainer.style.display = 'none';
            // Limpa lista de advogados
            document.getElementById('listaAdvogados').innerHTML = '';
        }
    });
    
    // ========== GESTÃO DE PESSOAS (CLIENTES/ADVOGADOS) ==========
    
    window.adicionarPessoa = function(tipo, dados = {}) {
        const lista = document.getElementById('lista' + (tipo === 'cliente' ? 'Clientes' : 'Advogados'));
        const row = document.createElement('tr');
        row.className = 'pessoa-row';
        
        const idValue = dados.id || '';
        const docValue = dados.documento || '';
        const nomeValue = dados.nome || '';
        const readOnly = idValue ? 'readonly' : '';
        
        // Advogado: apenas CPF | Cliente: CPF ou CNPJ
        const isAdvogado = tipo === 'advogado';
        const placeholder = isAdvogado ? '000.000.000-00' : '000.000.000-00 ou 00.000.000/0000-00';
        const maxLength = isAdvogado ? '14' : '18'; // CPF formatado = 14 chars, CNPJ = 18
        const labelNome = isAdvogado ? 'Nome do advogado' : 'Nome completo';
        
        row.innerHTML = `
            <td>
                <input type="hidden" name="${tipo}_id[]" value="${idValue}">
                <input type="text" class="form-control documento-input" 
                       name="${tipo}_documento[]" 
                       placeholder="${placeholder}"
                       value="${docValue}"
                       maxlength="${maxLength}"
                       data-tipo="${tipo}">
            </td>
            <td>
                <input type="text" class="form-control nome-input" 
                       name="${tipo}_nome[]" 
                       placeholder="${labelNome}"
                       value="${nomeValue}"
                       ${readOnly}>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerPessoa(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        lista.appendChild(row);
        
        // Adiciona eventos
        const docInput = row.querySelector('.documento-input');
        const nomeInput = row.querySelector('.nome-input');
        
        // Máscara ao digitar - diferenciada para advogado (só CPF)
        docInput.addEventListener('input', function() {
            if (isAdvogado) {
                // Advogado: força apenas máscara de CPF
                this.value = maskCPF(this.value);
            } else {
                // Cliente: permite CPF ou CNPJ
                this.value = maskDocumento(this.value);
            }
        });
        
        // Busca ao sair do campo
        docInput.addEventListener('blur', function() {
            buscarCliente(this, nomeInput, row.querySelector('input[type="hidden"]'));
        });
        
        // Formata valor inicial se houver
        if (docValue) {
            if (isAdvogado) {
                docInput.value = maskCPF(docValue);
            } else {
                docInput.value = maskDocumento(docValue);
            }
        }
        
        // Foca no campo de documento
        if (!idValue) {
            docInput.focus();
        }
    };
    
    window.removerPessoa = function(btn) {
        btn.closest('tr').remove();
    };
    
    async function buscarCliente(docInput, nomeInput, idInput) {
        const documento = docInput.value.replace(/\D/g, '');
        
        if (documento.length < 11) {
            return; // Documento muito curto
        }
        
        try {
            const response = await fetch(`{% url 'api_buscar_cliente' %}?documento=${documento}`);
            const data = await response.json();
            
            if (data.found) {
                nomeInput.value = data.nome;
                nomeInput.readOnly = true;
                idInput.value = data.id;
                nomeInput.classList.add('bg-success-subtle');
                setTimeout(() => nomeInput.classList.remove('bg-success-subtle'), 1000);
            } else {
                nomeInput.readOnly = false;
                idInput.value = '';
                nomeInput.focus();
            }
        } catch (error) {
            console.error('Erro ao buscar cliente:', error);
        }
    }
    
    // ========== GESTÃO DE DOCUMENTOS ==========
    
    window.adicionarDocumento = function(valor = '') {
        const lista = document.getElementById('listaDocumentos');
        const item = document.createElement('div');
        item.className = 'documento-item';
        
        item.innerHTML = `
            <input type="text" class="form-control" 
                   name="documento_item[]" 
                   placeholder="Ex: Certidão de Nascimento, RG, Comprovante de Endereço..."
                   value="${valor}">
            <button type="button" class="btn btn-outline-danger" onclick="removerDocumento(this)">
                <i class="bi bi-trash"></i>
            </button>
        `;
        
        lista.appendChild(item);
        
        if (!valor) {
            item.querySelector('input').focus();
        }
    };
    
    window.removerDocumento = function(btn) {
        btn.closest('.documento-item').remove();
    };
    
    // ========== INICIALIZAÇÃO COM DADOS EXISTENTES ==========
    
    // Carrega clientes existentes
    const clientesData = {{ clientes_data|safe }};
    if (clientesData && clientesData.length > 0) {
        clientesData.forEach(c => adicionarPessoa('cliente', c));
    } else {
        // Adiciona uma linha vazia para novo protocolo
        adicionarPessoa('cliente');
    }
    
    // Carrega advogados existentes
    const advogadosData = {{ advogados_data|safe }};
    if (advogadosData && advogadosData.length > 0) {
        advogadosData.forEach(a => adicionarPessoa('advogado', a));
    }
    
    // Carrega documentos existentes
    const documentosData = {{ documentos_data|safe }};
    if (documentosData && documentosData.length > 0) {
        documentosData.forEach(d => adicionarDocumento(d));
    }
    
    // ========== VALIDAÇÃO ANTES DE ENVIAR ==========
    
    document.getElementById('formProtocolo').addEventListener('submit', function(e) {
        const clientes = document.querySelectorAll('#listaClientes .pessoa-row');
        let temClienteValido = false;
        
        clientes.forEach(row => {
            const doc = row.querySelector('.documento-input').value.replace(/\D/g, '');
            const nome = row.querySelector('.nome-input').value.trim();
            if (doc.length >= 11 && nome) {
                temClienteValido = true;
            }
        });
        
        if (!temClienteValido) {
            e.preventDefault();
            alert('Adicione pelo menos um solicitante com CPF/CNPJ e nome válidos.');
            return false;
        }
    });
});
</script>
{% endblock %}
