{% extends 'core/base.html' %}
{% load format_utils %}

{% block title %}{{ title }} - Sistema de Protocolos{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <h1><i class="bi bi-file-earmark-text me-2"></i>{{ title }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Início</a></li>
                <li class="breadcrumb-item active">Protocolo de Certidão</li>
            </ol>
        </nav>
    </div>
    {% if is_edit and protocolo %}
    <span class="badge bg-primary-subtle text-primary px-3 py-2 fs-6">
        <i class="bi bi-hash me-1"></i>{{ protocolo.numero_protocolo }}
    </span>
    {% endif %}
</div>

<form method="post" id="formProtocolo" novalidate>
    {% csrf_token %}
    {% if success %}
    <fieldset disabled>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>Protocolo salvo com sucesso!</strong> O protocolo {{ protocolo.numero_protocolo }} foi registrado no sistema.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ form.non_field_errors|join:', ' }}
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- Coluna Principal -->
        <div class="col-12 col-xl-8">
            
            <!-- Card: Dados do Pedido -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h5 class="mb-0"><i class="bi bi-clipboard me-2"></i>Dados do Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-medium" for="id_tipo_ato">
                                Tipo de Certidão <span class="text-danger">*</span>
                            </label>
                            {{ form.tipo_ato }}
                            {% if form.tipo_ato.errors %}
                            <div class="invalid-feedback d-block">{{ form.tipo_ato.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-medium" for="id_data_agendamento">
                                Data de Entrega
                            </label>
                            {{ form.data_agendamento }}
                            {% if form.data_agendamento.errors %}
                            <div class="invalid-feedback d-block">{{ form.data_agendamento.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-medium" for="id_responsavel">
                                Responsável pelo Protocolo <span class="text-danger">*</span>
                            </label>
                            {{ form.responsavel }}
                            {% if form.responsavel.errors %}
                            <div class="invalid-feedback d-block">{{ form.responsavel.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium" for="id_horario_agendamento">
                                Horário
                            </label>
                            {{ form.horario_agendamento }}
                            {% if form.horario_agendamento.errors %}
                            <div class="invalid-feedback d-block">{{ form.horario_agendamento.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Solicitantes (Clientes) -->
            <div class="card mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Solicitantes</h5>
                    {% if not success %}
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarPessoa('cliente')">
                        <i class="bi bi-plus-lg me-1"></i>Adicionar Solicitante
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="listaClientes">
                        <!-- Cards de clientes serão adicionados via JS -->
                    </div>
                    <div class="alert alert-info mb-0 mt-3 small">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Dica:</strong> Digite o CPF/CNPJ e pressione Tab. Se o cliente existir, os dados serão preenchidos automaticamente.
                        Você pode editar as informações para atualizá-las no cadastro.
                    </div>
                </div>
            </div>

            <!-- Card: Advogados (Toggle) -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-briefcase me-2"></i>Advogados</h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" role="switch" 
                                   id="toggle_advogados" name="tem_advogado"
                                   {% if has_advogados %}checked{% endif %}>
                            <label class="form-check-label" for="toggle_advogados">Possui advogado?</label>
                        </div>
                    </div>
                </div>
                <div id="advogados_container" style="{% if not has_advogados %}display: none;{% endif %}">
                    <div class="card-body">
                        {% if not success %}
                        <div class="d-flex justify-content-end mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarPessoa('advogado')">
                                <i class="bi bi-plus-lg me-1"></i>Adicionar Advogado
                            </button>
                        </div>
                        {% endif %}
                        <div id="listaAdvogados">
                            <!-- Cards de advogados serão adicionados via JS -->
                        </div>
                        <div class="alert alert-secondary mb-0 mt-3 small">
                            <i class="bi bi-info-circle me-1"></i>
                            Advogados devem ser cadastrados com CPF (pessoa física).
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Lista de Documentos -->
            <div class="card mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-check me-2"></i>Documentos Solicitados</h5>
                    {% if not success %}
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarDocumento()">
                        <i class="bi bi-plus-lg me-1"></i>Adicionar
                    </button>
                    {% endif %}
                </div>
                <div class="card-body" id="listaDocumentos">
                    <!-- Itens serão adicionados via JS -->
                </div>
                <div class="card-footer bg-light text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Liste os documentos que o cliente precisa apresentar ou que serão emitidos.
                </div>
            </div>

            <!-- Card: Observações -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>Observações</h5>
                </div>
                <div class="card-body">
                    {{ form.observacoes }}
                </div>
            </div>
        </div>

        <!-- Coluna Lateral -->
        <div class="col-12 col-xl-4">
            <!-- Card: Financeiro -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Financeiro</h5>
                </div>
                <div class="card-body">
                    <label class="form-label fw-medium" for="id_deposito_previo">
                        Depósito Prévio (R$) <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        {{ form.deposito_previo }}
                    </div>
                    {% if form.deposito_previo.errors %}
                    <div class="invalid-feedback d-block">{{ form.deposito_previo.errors|join:', ' }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Card: Resumo/Ajuda -->
            <div class="card bg-light border-0">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-lightbulb me-1"></i>Dicas</h6>
                    <hr>
                    <ul class="small text-muted mb-0 ps-3">
                        <li class="mb-2">Adicione ao menos um <strong>solicitante</strong>.</li>
                        <li class="mb-2">Se o cliente não existir, ele será <strong>cadastrado automaticamente</strong> ao salvar.</li>
                        <li class="mb-2">Advogados usam a mesma base de clientes.</li>
                        <li>Documentos são opcionais, mas ajudam no controle.</li>
                    </ul>
                </div>
            </div>

            {% if is_edit and protocolo %}
            <div class="card border-0 bg-info-subtle mt-3">
                <div class="card-body">
                    <h6 class="text-info"><i class="bi bi-info-circle me-1"></i>Informações</h6>
                    <hr class="border-info">
                    <ul class="list-unstyled small mb-0">
                        <li><strong>Criado por:</strong> {{ protocolo.criado_por.get_full_name|default:protocolo.criado_por.username }}</li>
                        <li><strong>Data:</strong> {{ protocolo.data_criacao|date:"d/m/Y H:i" }}</li>
                        <li><strong>Status:</strong> {{ protocolo.get_status_display }}</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if success %}
    </fieldset>
    {% endif %}

    <!-- Botões de Ação -->
    <div class="d-flex justify-content-end gap-2 mt-4 mb-5">
        {% if success %}
            <!-- Botões após salvamento bem-sucedido -->
            <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-house me-1"></i>Home
            </a>
            <button type="button" class="btn btn-primary btn-lg" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>Imprimir
            </button>
        {% else %}
            <!-- Botões no fluxo normal/edição -->
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg me-1"></i>Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-lg me-1"></i>{{ button_text }}
            </button>
        {% endif %}
    </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para campos desabilitados quando protocolo foi salvo */
    fieldset:disabled {
        opacity: 0.85;
        pointer-events: none;
    }
    
    fieldset:disabled .form-control,
    fieldset:disabled .form-select,
    fieldset:disabled .btn:not(.btn-close) {
        cursor: not-allowed;
        background-color: #f8f9fa;
    }
    
    fieldset:disabled .pessoa-card {
        opacity: 0.9;
    }
    
    .pessoa-row input:read-only {
        background-color: #e9ecef;
    }
    
    .documento-item {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .documento-item input {
        flex: 1;
    }
    
    #listaDocumentos:empty::after {
        content: 'Nenhum documento adicionado. Clique em "Adicionar" para incluir.';
        display: block;
        text-align: center;
        color: #6c757d;
        padding: 2rem;
    }
    
    #listaClientes:empty::after,
    #listaAdvogados:empty::after {
        content: 'Nenhum registro. Clique em "Adicionar" para incluir.';
        display: block;
        text-align: center;
        color: #6c757d;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 2px dashed #dee2e6;
    }
    
    /* Estilo dos cards de pessoa */
    .pessoa-card {
        transition: all 0.3s ease;
    }
    
    .pessoa-card:hover {
        box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.1);
    }
    
    .pessoa-card .form-label {
        font-weight: 500;
    }
    
    .pessoa-card .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ========== MÁSCARAS ==========
    
    function maskCPF(value) {
        let v = value.replace(/\D/g, '').substring(0, 11);
        if (v.length > 9) {
            v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        } else if (v.length > 6) {
            v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
        } else if (v.length > 3) {
            v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
        }
        return v;
    }
    
    function maskCNPJ(value) {
        let v = value.replace(/\D/g, '').substring(0, 14);
        if (v.length > 12) {
            v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{1,2})/, '$1.$2.$3/$4-$5');
        } else if (v.length > 8) {
            v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{1,4})/, '$1.$2.$3/$4');
        } else if (v.length > 5) {
            v = v.replace(/(\d{2})(\d{3})(\d{1,3})/, '$1.$2.$3');
        } else if (v.length > 2) {
            v = v.replace(/(\d{2})(\d{1,3})/, '$1.$2');
        }
        return v;
    }
    
    function maskDocumento(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length <= 11) {
            return maskCPF(value);
        } else {
            return maskCNPJ(value);
        }
    }
    
    // ========== TOGGLE ADVOGADOS ==========
    
    const toggleAdvogados = document.getElementById('toggle_advogados');
    const advogadosContainer = document.getElementById('advogados_container');
    
    toggleAdvogados.addEventListener('change', function() {
        if (this.checked) {
            advogadosContainer.style.display = 'block';
        } else {
            advogadosContainer.style.display = 'none';
            // Limpa lista de advogados
            document.getElementById('listaAdvogados').innerHTML = '';
        }
    });
    
    // ========== MÁSCARA DE TELEFONE ==========
    
    function maskTelefone(value) {
        let v = value.replace(/\D/g, '').substring(0, 11);
        if (v.length > 10) {
            // Celular: (00) 00000-0000
            v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (v.length > 6) {
            // Fixo: (00) 0000-0000
            v = v.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else if (v.length > 2) {
            v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
        }
        return v;
    }
    
    // ========== GESTÃO DE PESSOAS (CLIENTES/ADVOGADOS) ==========
    
    const isSuccess = {{ success|yesno:"true,false" }};
    
    let pessoaCounter = 0;
    
    window.adicionarPessoa = function(tipo, dados = {}) {
        // Não permite adicionar se o protocolo já foi salvo
        if (isSuccess) {
            return;
        }
        const lista = document.getElementById('lista' + (tipo === 'cliente' ? 'Clientes' : 'Advogados'));
        const card = document.createElement('div');
        card.className = 'pessoa-card card border mb-3';
        pessoaCounter++;
        
        const idValue = dados.id || '';
        const docValue = dados.documento || '';
        const nomeValue = dados.nome || '';
        const telefoneValue = dados.telefone || '';
        const emailValue = dados.email || '';
        const enderecoValue = dados.endereco || '';
        
        // Advogado: apenas CPF | Cliente: CPF ou CNPJ
        const isAdvogado = tipo === 'advogado';
        const placeholderDoc = isAdvogado ? '000.000.000-00' : '000.000.000-00 ou 00.000.000/0000-00';
        const maxLength = isAdvogado ? '14' : '18';
        const labelDoc = isAdvogado ? 'CPF do Advogado' : 'CPF/CNPJ';
        const labelNome = isAdvogado ? 'Nome do Advogado' : 'Nome Completo / Razão Social';
        const cardBg = isAdvogado ? 'bg-light' : '';
        
        card.innerHTML = `
            <div class="card-body ${cardBg}">
                <input type="hidden" name="${tipo}_id[]" value="${idValue}" class="pessoa-id">
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <span class="badge bg-secondary-subtle text-secondary">
                        <i class="bi bi-person me-1"></i>${isAdvogado ? 'Advogado' : 'Solicitante'} #${pessoaCounter}
                    </span>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerPessoa(this)" title="Remover">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                
                <!-- Linha 1: Documento e Nome -->
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label small text-muted mb-1">${labelDoc} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control documento-input" 
                               name="${tipo}_documento[]" 
                               placeholder="${placeholderDoc}"
                               value="${docValue}"
                               maxlength="${maxLength}"
                               data-tipo="${tipo}"
                               required>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label small text-muted mb-1">${labelNome} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control nome-input" 
                               name="${tipo}_nome[]" 
                               placeholder="${labelNome}"
                               value="${nomeValue}"
                               required>
                    </div>
                </div>
                
                <!-- Linha 2: Telefone e E-mail -->
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label small text-muted mb-1"><i class="bi bi-telephone me-1"></i>Telefone</label>
                        <input type="text" class="form-control telefone-input" 
                               name="${tipo}_telefone[]" 
                               placeholder="(00) 00000-0000"
                               value="${telefoneValue}"
                               maxlength="15">
                    </div>
                    <div class="col-md-8">
                        <label class="form-label small text-muted mb-1"><i class="bi bi-envelope me-1"></i>E-mail</label>
                        <input type="email" class="form-control email-input" 
                               name="${tipo}_email[]" 
                               placeholder="email@exemplo.com"
                               value="${emailValue}">
                    </div>
                </div>
                
                <!-- Linha 3: Endereço -->
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label small text-muted mb-1"><i class="bi bi-geo-alt me-1"></i>Endereço</label>
                        <input type="text" class="form-control endereco-input" 
                               name="${tipo}_endereco[]" 
                               placeholder="Rua, número, bairro, cidade - UF"
                               value="${enderecoValue}">
                    </div>
                </div>
            </div>
        `;
        
        lista.appendChild(card);
        
        // Referências aos inputs
        const docInput = card.querySelector('.documento-input');
        const nomeInput = card.querySelector('.nome-input');
        const telefoneInput = card.querySelector('.telefone-input');
        const emailInput = card.querySelector('.email-input');
        const enderecoInput = card.querySelector('.endereco-input');
        const idInput = card.querySelector('.pessoa-id');
        
        // Máscara de documento ao digitar
        docInput.addEventListener('input', function() {
            if (isAdvogado) {
                this.value = maskCPF(this.value);
            } else {
                this.value = maskDocumento(this.value);
            }
        });
        
        // Máscara de telefone
        telefoneInput.addEventListener('input', function() {
            this.value = maskTelefone(this.value);
        });
        
        // Busca ao sair do campo de documento (apenas se não estiver em modo de sucesso)
        if (!isSuccess) {
            docInput.addEventListener('blur', function() {
                buscarCliente(this, card);
            });
        }
        
        // Formata valores iniciais
        if (docValue) {
            docInput.value = isAdvogado ? maskCPF(docValue) : maskDocumento(docValue);
        }
        if (telefoneValue) {
            telefoneInput.value = maskTelefone(telefoneValue);
        }
        
        // Foca no campo de documento se for novo
        if (!idValue) {
            docInput.focus();
        }
    };
    
    window.removerPessoa = function(btn) {
        // Não permite remover se o protocolo já foi salvo
        if (isSuccess) {
            return;
        }
        btn.closest('.pessoa-card').remove();
    };
    
    async function buscarCliente(docInput, card) {
        const documento = docInput.value.replace(/\D/g, '');
        
        if (documento.length < 11) {
            return; // Documento muito curto
        }
        
        // Referencias aos campos do card
        const nomeInput = card.querySelector('.nome-input');
        const telefoneInput = card.querySelector('.telefone-input');
        const emailInput = card.querySelector('.email-input');
        const enderecoInput = card.querySelector('.endereco-input');
        const idInput = card.querySelector('.pessoa-id');
        
        try {
            const response = await fetch(`{% url 'api_buscar_cliente' %}?documento=${documento}`);
            const data = await response.json();
            
            if (data.found) {
                // Preenche todos os campos
                nomeInput.value = data.nome;
                telefoneInput.value = maskTelefone(data.telefone || '');
                emailInput.value = data.email || '';
                enderecoInput.value = data.endereco || '';
                idInput.value = data.id;
                
                // Feedback visual de sucesso
                card.classList.add('border-success');
                card.querySelector('.card-body').classList.add('bg-success-subtle');
                
                setTimeout(() => {
                    card.classList.remove('border-success');
                    card.querySelector('.card-body').classList.remove('bg-success-subtle');
                }, 1500);
                
            } else {
                // Cliente não encontrado - limpa ID e permite edição
                idInput.value = '';
                nomeInput.focus();
            }
        } catch (error) {
            console.error('Erro ao buscar cliente:', error);
        }
    }
    
    // ========== GESTÃO DE DOCUMENTOS ==========
    
    window.adicionarDocumento = function(valor = '') {
        // Não permite adicionar se o protocolo já foi salvo
        if (isSuccess) {
            return;
        }
        const lista = document.getElementById('listaDocumentos');
        const item = document.createElement('div');
        item.className = 'documento-item';
        
        item.innerHTML = `
            <input type="text" class="form-control" 
                   name="documento_item[]" 
                   placeholder="Ex: Certidão de Nascimento, RG, Comprovante de Endereço..."
                   value="${valor}">
            <button type="button" class="btn btn-outline-danger" onclick="removerDocumento(this)">
                <i class="bi bi-trash"></i>
            </button>
        `;
        
        lista.appendChild(item);
        
        if (!valor) {
            item.querySelector('input').focus();
        }
    };
    
    window.removerDocumento = function(btn) {
        // Não permite remover se o protocolo já foi salvo
        if (isSuccess) {
            return;
        }
        btn.closest('.documento-item').remove();
    };
    
    // ========== INICIALIZAÇÃO COM DADOS EXISTENTES ==========
    
    // Carrega clientes existentes
    const clientesData = {{ clientes_data|safe }};
    if (clientesData && clientesData.length > 0) {
        clientesData.forEach(c => adicionarPessoa('cliente', c));
    } else {
        // Adiciona uma linha vazia para novo protocolo
        adicionarPessoa('cliente');
    }
    
    // Carrega advogados existentes
    const advogadosData = {{ advogados_data|safe }};
    if (advogadosData && advogadosData.length > 0) {
        advogadosData.forEach(a => adicionarPessoa('advogado', a));
    }
    
    // Carrega documentos existentes
    const documentosData = {{ documentos_data|safe }};
    if (documentosData && documentosData.length > 0) {
        documentosData.forEach(d => adicionarDocumento(d));
    }
    
    // ========== VALIDAÇÃO ANTES DE ENVIAR ==========
    
    // Desabilita submissão se já foi salvo
    if (isSuccess) {
        document.getElementById('formProtocolo').addEventListener('submit', function(e) {
            e.preventDefault();
            return false;
        });
    } else {
        document.getElementById('formProtocolo').addEventListener('submit', function(e) {
        const clientes = document.querySelectorAll('#listaClientes .pessoa-card');
        let temClienteValido = false;
        
        clientes.forEach(card => {
            const doc = card.querySelector('.documento-input').value.replace(/\D/g, '');
            const nome = card.querySelector('.nome-input').value.trim();
            if (doc.length >= 11 && nome) {
                temClienteValido = true;
            }
        });
        
        if (!temClienteValido) {
            e.preventDefault();
            alert('Adicione pelo menos um solicitante com CPF/CNPJ e nome válidos.');
            return false;
        }
    });
    }
});
</script>
{% endblock %}
